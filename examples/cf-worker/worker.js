var l=class{constructor(e){Object.defineProperty(this,"app",{enumerable:!0,configurable:!0,writable:!0,value:e})}async authorize(e){let t=new URL(e.url);if(!t.searchParams.has("shop-url")||!e.headers.has("shopware-app-signature")||!t.searchParams.has("shop-id")||!t.searchParams.has("timestamp"))throw new Error("Invalid Request");if(!await this.app.signer.verify(e.headers.get("shopware-app-signature"),`shop-id=${t.searchParams.get("shop-id")}&shop-url=${t.searchParams.get("shop-url")}&timestamp=${t.searchParams.get("timestamp")}`,this.app.cfg.appSecret))throw new Error("Cannot validate app signature");let a=this.app.repository.createShopStruct(t.searchParams.get("shop-id"),t.searchParams.get("shop-url"),S());return await this.app.repository.createShop(a),new Response(JSON.stringify({proof:await this.app.signer.sign(a.getShopId()+a.getShopUrl()+this.app.cfg.appName,this.app.cfg.appSecret),secret:a.getShopSecret(),confirmation_url:this.app.cfg.authorizeCallbackUrl}),{headers:{"content-type":"application/json"}})}async authorizeCallback(e){let t=await e.text(),r=JSON.parse(t);if(typeof r.shopId!="string"||typeof r.apiKey!="string"||typeof r.secretKey!="string"||!e.headers.has("shopware-shop-signature"))throw new Error("Invalid Request");let a=await this.app.repository.getShopById(r.shopId);if(a===null)throw new Error(`Cannot find shop for this id: ${r.shopId}`);if(!await this.app.signer.verify(e.headers.get("shopware-shop-signature"),t,a.getShopSecret()))throw await this.app.repository.deleteShop(a.getShopId()),new Error("Cannot validate app signature");return a.setShopCredentials(r.apiKey,r.secretKey),await this.app.repository.updateShop(a),new Response(null,{status:204})}};function S(){let s=()=>Math.random().toString(36).substring(2);return s()+s()}var n=class{constructor(e){Object.defineProperty(this,"shop",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"storage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.storage={token:null,expiresIn:null}}async get(e,t={}){return await this.request("GET",e,null,t)}async post(e,t={},r={}){return r["content-type"]="application/json",r.accept="application/json",await this.request("POST",e,JSON.stringify(t),r)}async put(e,t={},r={}){return r["content-type"]="application/json",r.accept="application/json",await this.request("PUT",e,JSON.stringify(t),r)}async patch(e,t={},r={}){return r["content-type"]="application/json",r.accept="application/json",await this.request("PATCH",e,JSON.stringify(t),r)}async delete(e,t={},r={}){return r["content-type"]="application/json",r.accept="application/json",await this.request("DELETE",e,JSON.stringify(t),r)}async request(e,t,r="",a={}){let u=Object.assign({},a);u.Authorization=`Bearer ${await this.getToken()}`;let o=await globalThis.fetch(`${this.shop.getShopUrl()}/api${t}`,{body:r,headers:u,method:e});if(!o.ok&&o.status===401)return this.storage.expiresIn=null,await this.request(e,t,r,a);if(!o.ok)throw new y(this.shop.getShopId(),new i(o.status,await o.json(),o.headers));return o.status===204?new i(o.status,{},o.headers):new i(o.status,await o.json(),o.headers)}async getToken(){if(this.storage.expiresIn===null){let e=await globalThis.fetch(`${this.shop.getShopUrl()}/api/oauth/token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({grant_type:"client_credentials",client_id:this.shop.getShopClientId(),client_secret:this.shop.getShopClientSecret()})});if(!e.ok)throw new w(this.shop.getShopId(),new i(e.status,await e.json(),e.headers));let t=new Date,r=await e.json();return this.storage.token=r.access_token,t.setSeconds(t.getSeconds()+r.expires_in),this.storage.expiresIn=t,this.storage.token}return this.storage.expiresIn.getTime()<new Date().getTime()?(this.storage.expiresIn=null,await this.getToken()):this.storage.token}},i=class{constructor(e,t,r){Object.defineProperty(this,"statusCode",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"body",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:r})}},w=class extends Error{constructor(e,t){super(`The api client authentication to shop with id: ${e}`),Object.defineProperty(this,"response",{enumerable:!0,configurable:!0,writable:!0,value:t})}},y=class extends Error{constructor(e,t){super(`The api request failed with status code: ${t.statusCode} for shop with id: ${e}`),Object.defineProperty(this,"response",{enumerable:!0,configurable:!0,writable:!0,value:t})}};var g=class{constructor(e){Object.defineProperty(this,"app",{enumerable:!0,configurable:!0,writable:!0,value:e})}async fromSource(e){let t=await e.text(),r=JSON.parse(t),a=await this.app.repository.getShopById(r.source.shopId);if(a===null)throw new Error(`Cannot find shop by id ${r.source.shopId}`);return await this.app.signer.verify(e.headers.get("shopware-shop-signature"),t,a.getShopSecret()),new b(a,r,new n(a))}async fromModule(e){let t=new URL(e.url),r=await this.app.repository.getShopById(t.searchParams.get("shop-id"));if(r===null)throw new Error(`Cannot find shop by id ${t.searchParams.get("shop-id")}`);await this.app.signer.verifyGetRequest(e,r.getShopSecret());let a={};return t.searchParams.forEach((u,o)=>{a[o]=u}),new b(r,a,new n(r))}},b=class{constructor(e,t,r){Object.defineProperty(this,"shop",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"payload",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"httpClient",{enumerable:!0,configurable:!0,writable:!0,value:r})}};var h=class{constructor(e,t,r){Object.defineProperty(this,"cfg",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"repository",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"signer",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"registration",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"contextResolver",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.registration=new l(this),this.contextResolver=new g(this)}};var d=class{async signResponse(e,t){e.headers.set("shopware-app-signature",await this.sign(await e.text(),t))}async verifyGetRequest(e,t){let r=new URL(e.url),a=r.searchParams.get("shopware-shop-signature");return r.searchParams.delete("shopware-shop-signature"),await this.verify(a,r.searchParams.toString(),t)}},c=class extends d{constructor(){super(),Object.defineProperty(this,"encoder",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyCache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.encoder=new TextEncoder,this.keyCache=new Map}async getKeyForSecret(e){if(this.keyCache.has(e))return this.keyCache.get(e);let t=this.encoder.encode(e),r=await crypto.subtle.importKey("raw",t,{name:"HMAC",hash:"SHA-256"},!1,["sign","verify"]);return this.keyCache.set(e,r),r}async sign(e,t){let r=await this.getKeyForSecret(t),a=await crypto.subtle.sign("HMAC",r,this.encoder.encode(e));return this.buf2hex(a)}async verify(e,t,r){let a=await this.sign(t,r);return e===a}buf2hex(e){return Array.prototype.map.call(new Uint8Array(e),t=>("00"+t.toString(16)).slice(-2)).join("")}};var p=class{constructor(e,t,r){Object.defineProperty(this,"shopId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"shopUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"shopSecret",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"shopClientId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"shopClientSecret",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.shopId=e,this.shopUrl=t,this.shopSecret=r,this.shopClientId=null,this.shopClientSecret=null}getShopId(){return this.shopId}getShopUrl(){return this.shopUrl}getShopSecret(){return this.shopSecret}getShopClientId(){return this.shopClientId}getShopClientSecret(){return this.shopClientSecret}setShopCredentials(e,t){this.shopClientId=e,this.shopClientSecret=t}};var f=class{constructor(e){Object.defineProperty(this,"storage",{enumerable:!0,configurable:!0,writable:!0,value:e}),this.storage=e}createShopStruct(e,t,r){return new p(e,t,r)}async createShop(e){await this.storage.put(e.getShopId(),this.serializeShop(e))}async deleteShop(e){await this.storage.delete(e)}async getShopById(e){let t=await this.storage.get(e);return t===null?null:this.deserializeShop(t)}async updateShop(e){return await this.createShop(e)}serializeShop(e){return JSON.stringify(e)}deserializeShop(e){let t=JSON.parse(e),r=new p(t.shopId||"",t.shopUrl||"",t.shopSecret||"");return r.setShopCredentials(t.clientId||"",t.clientSecret||""),r}};var m={appName:"Test",appSecret:"testSecret",authorizeCallbackUrl:"https://xxxx.shyim.workers.dev/authorize/callback"},se={async fetch(s,e){let t=new URL(s.url),r=new h(m,new f(e.shopStorage),new c);return t.pathname.startsWith("/authorize/callback")?await r.registration.authorizeCallback(s):t.pathname.startsWith("/authorize")?await r.registration.authorize(s):new Response("Not found")}};export{se as default};
//# sourceMappingURL=worker.js.map
